# AI Auto Poster プラグイン - 光回線サイト向け実装

## 1. プロジェクトの目的

このプロジェクトは、WordPressサイトで光回線関連の記事を自動生成するためのプラグインを開発することを目的としています。主な特徴は以下の通りです：

- 階層化されたカテゴリ（親・子・孫）に基づく記事生成
- OpenAI APIを利用した高品質なコンテンツ生成
- サーバーサイドCronによる定期的な記事自動生成
- 直感的な管理画面UIの提供

## 2. 主要機能

### 2.1 カテゴリ管理システム

- 3階層（親・子・孫）のカテゴリ構造をサポート
- 視覚的な階層表示（インデント + 折りたたみ機能）
- カテゴリの一括有効/無効切り替え（親から子へ伝播）
- カテゴリの状態管理（中間状態の表示）

### 2.2 記事生成エンジン

- OpenAI APIを利用した自然な文章生成
- カテゴリに基づいた適切なコンテキスト生成
- 記事構造の自動組み立て（見出し、本文、ボックス要素）
- Gutenbergブロックフォーマットでの出力

### 2.3 定期実行システム

- さくらのレンタルサーバーのCronを利用
- ロック機能による重複実行の防止
- エラーログの出力と監視
- 設定可能な投稿ステータス（下書き/公開）

## 3. 技術的実装

### 3.1 ファイル構造

```
ai-auto-poster/
├── ai-auto-poster.php        # メインプラグインファイル
├── includes/
│   ├── class-content-generator.php  # コンテンツ生成ロジック
│   ├── class-image-generator.php    # 画像生成（未使用）
│   ├── class-block-converter.php    # Gutenbergブロック変換
│   ├── class-openai-client.php      # OpenAI API通信
│   └── class-logger.php             # ログ管理
└── cron/
    └── generate_post.php      # Cron実行スクリプト
```

### 3.2 主要クラスの役割

#### AIAP_Lite_Box（ai-auto-poster.php）

- プラグインの初期化と設定画面の提供
- WordPressフックの管理
- 記事生成プロセスの統括
- ロック機能の実装

#### AIAP_Content_Generator（class-content-generator.php）

- OpenAI APIとの対話
- 記事構造の設計
- カテゴリベースのコンテキスト生成
- 生成された内容の整形

### 3.3 定期実行の実装

#### Cronの設定

```bash
# さくらのレンタルサーバーでのCron設定例
0 10 * * * /usr/local/bin/php /www/yk-test/media/wp-content/plugins/ai-auto-poster/cron/generate_post.php >> /tmp/cron.log 2>&1
```

#### 実行フロー

1. WordPress環境のロード
2. セキュリティチェック（CLI実行の確認）
3. プラグインクラスの初期化
4. ロック状態の確認
5. 記事生成プロセスの実行
6. ログの出力
7. ロックの解放

### 3.4 カテゴリ管理のUI実装

#### HTML/CSS構造

- Flexboxベースのレイアウト
- WordPressの標準UIコンポーネントの活用
- ダッシュアイコンによる階層表示
- CSSアニメーションによる展開/折りたたみ

#### JavaScript機能

- チェックボックスの連動制御
- 親子関係の状態管理
- 展開/折りたたみのトグル
- 初期状態の設定

## 4. 設定項目

### 4.1 基本設定

- OpenAI APIキー
- 投稿ステータス（下書き/公開）
- 自動投稿の有効/無効

### 4.2 カテゴリ設定

- カテゴリの有効/無効状態
- 階層構造の管理
- 記事生成対象の選択

## 5. エラー処理とログ

### 5.1 エラーログの出力先

- WordPress標準のerror_log
- 専用のCronログ（/tmp/cron.log）

### 5.2 主要なエラーチェック

- APIキーの存在確認
- 有効なカテゴリの存在確認
- ロック状態のチェック
- 実行環境の確認

## 6. 今後の改善点

### 6.1 機能拡張

- カテゴリごとの生成頻度設定
- より詳細なコンテンツ設定
- エラー通知システムの実装
- バックアップ機能の追加

### 6.2 パフォーマンス改善

- APIリクエストの最適化
- キャッシュシステムの導入
- データベースクエリの効率化

## 7. 運用上の注意点

### 7.1 定期実行の管理

- Cronログの定期的な確認
- エラー発生時の対応手順
- バックアップの実施

### 7.2 コンテンツ品質の管理

- 生成された記事の定期的なレビュー
- カテゴリ設定の見直し
- APIプロンプトの調整

## 8. トラブルシューティング

### 8.1 一般的な問題と解決方法

1. Cronが実行されない

   - パスの確認
   - 実行権限の確認
   - ログの確認

2. 記事が生成されない

   - APIキーの確認
   - カテゴリ設定の確認
   - ロック状態の確認

3. エラーログの確認方法
   - WordPressのデバッグログ
   - Cronの実行ログ
   - PHPのエラーログ
